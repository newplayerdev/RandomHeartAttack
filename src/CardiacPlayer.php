<?php

namespace NewPlayerMC\RandomHearthAttack;

use pocketmine\entity\Location;
use pocketmine\event\entity\EntityDamageEvent;
use pocketmine\nbt\tag\CompoundTag;
use pocketmine\network\mcpe\NetworkSession;
use pocketmine\player\GameMode;
use pocketmine\player\Player;
use pocketmine\player\PlayerInfo;
use pocketmine\Server;

class CardiacPlayer extends Player
{
    protected int $hearthAttackTick = 0;
    private const NBT_TAG_HATICKS = "hearthAttackTick";
    private const NBT_TAG_TICKSL = "ticksLived";

    public function __construct(Server $server, NetworkSession $session, PlayerInfo $playerInfo, bool $authenticated, Location $spawnLocation, ?CompoundTag $namedtag)
    {
        parent::__construct($server, $session, $playerInfo, $authenticated, $spawnLocation, $namedtag);

        if ($namedtag !== null && $namedtag->getInt(self::NBT_TAG_HATICKS) !== null) {
            $this->hearthAttackTick = $namedtag->getInt(self::NBT_TAG_HATICKS);
            $this->ticksLived = $namedtag->getInt(self::NBT_TAG_TICKSL);
        } else {
            $this->setRandomTicksToLive();
        }
    }

    public function saveNBT(): CompoundTag
    {
        $nbt = parent::saveNBT();
        $nbt->setInt(self::NBT_TAG_HATICKS, $this->hearthAttackTick);
        $nbt->setInt(self::NBT_TAG_TICKSL, $this->ticksLived);

        return $nbt;
    }

    /**
     * Returns the count of ticks the player has to live before having a hearth attack
     * @return int
     */
    public function getTicksToLive(): int {
        return $this->hearthAttackTick;
    }

    public function setRandomTicksToLive(): void {
        // Lets you approximatively 300 hours in game before having your hearth fail you
        $this->hearthAttackTick = mt_rand(0, mt_getrandmax()/100);
    }

    public function resetTicksLived(): void {
        $this->ticksLived = 0;
    }

    public function onUpdate(int $currentTick): bool
    {
        if ($this->getGamemode() === GameMode::SURVIVAL()) {
            if ($this->ticksLived >= $this->getTicksToLive()) {
                $event = new EntityDamageEvent($this, Main::CAUSE_HEARTH_ATTACK, 3.0);
                $event->call();
                if (!$event->isCancelled()) $this->attack($event);
            }
        }
        return parent::onUpdate($currentTick); // TODO: Change the autogenerated stub
    }

}